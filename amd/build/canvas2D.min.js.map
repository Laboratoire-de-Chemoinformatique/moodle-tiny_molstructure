{"version":3,"file":"canvas2D.min.js","sources":["../src/canvas2D.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Molstructure canvas init and functions.\n *\n * @module      tiny_molstructure/ui\n * @copyright   2024 University of Strasbourg unistra.fr\n * @author Céline Pervès <louis.plyer@unistra.fr>\n * @author Louis Plyer <louis.plyer@unistra.fr>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from 'tiny_molstructure/selectors';\nimport {get_string as getString} from 'core/str';\nimport {component} from 'tiny_molstructure/common';\n\nexport const initCanvas2D = async(editor,\n                                  iframeBody,\n                                  sketcherWidth=400,\n                                  sketcherHeight=200,\n                                  sketcherViewerWidth=100,\n                                  sketcherViewerHeight=100) => {\n  const iframeContent = iframeBody.contentDocument;\n  let ChemDoodle = iframeBody.contentWindow.ChemDoodleVar;\n  ChemDoodle.ELEMENT['H'].jmolColor = 'black';\n  ChemDoodle.ELEMENT['S'].jmolColor = '#B9A130';\n  // Main ketcher.\n  const sketcher = new ChemDoodle.SketcherCanvas('sketcher', sketcherWidth, sketcherHeight,\n    {useServices:false, requireStartingAtom: false});\n  // We init the ketcher with an empty molecule object.\n  ChemDoodle.readJSON(\"{\\\"m\\\":[{\\\"a\\\":[]}]}\");\n  sketcher.styles.atoms_displayTerminalCarbonLabels_2D = true;\n  sketcher.styles.atoms_useJMOLColors = true;\n  sketcher.styles.bonds_clearOverlaps_2D = true;\n  sketcher.repaint();\n\n  // Preview ketcher.\n  const sketcher_viewer = new ChemDoodle.ViewerCanvas('sketcher-viewer-tiny', sketcherViewerWidth, sketcherViewerHeight);\n  sketcher_viewer.styles.atoms_displayTerminalCarbonLabels_2D = true;\n  sketcher_viewer.styles.atoms_useJMOLColors = true;\n  sketcher_viewer.styles.bonds_clearOverlaps_2D = true;\n  //sketcher_viewer.repaint();\n  sketcher_viewer.emptyMessage = 'No data loaded';\n  sketcher.oldFunc = sketcher.checksOnAction;\n\n  /*   Refactor the function, in order for the preview ketcher to be a copy of the main ketcher,\n         updated at every modification of the main ketcher. */\n  sketcher.checksOnAction = function(force){\n    this.oldFunc(force);\n    //sketcher.repaint();\n    let mols = sketcher.molecules;\n    let forms = sketcher.shapes;\n    sketcher_viewer.loadContent(mols, forms);\n    sketcher.center();\n    for ( let i = 0, ii = this.molecules.length; i < ii; i++) {\n      this.molecules[i].check();\n    }\n  };\n  iframeBody.contentWindow.sketcherViewerVar = sketcher_viewer;\n  iframeContent.querySelector(Selectors.elements.canvas.resizeButton).addEventListener('click', function_resize, iframeBody);\n  // Need this for firefow ESR < 120 since has is not present by default\n  window.document.querySelector('.modal-content').setAttribute('style', ' height:100vh;');\n  await changeLangString(iframeContent);\n};\n\n/*  Button activated function, checks for the values of width and height in the input elements.\n    If empty, uses the default value. */\nexport const function_resize= (e) => {\n  const iframeContent = e.target.ownerDocument;\n  let input_width = iframeContent.querySelector(Selectors.elements.canvas.widthInput).valueAsNumber;\n  let input_height = iframeContent.querySelector(Selectors.elements.canvas.heightInput).valueAsNumber;\n  let sketcher_viewer = window.document.querySelector(Selectors.elements.canvas.selector2D).contentWindow.sketcherViewerVar;\n  let width;\n  let height;\n\n  if(input_width > 0 ) {\n    width = input_width;\n  } else {\n    width = 100;\n  }\n\n  if(input_height > 0 ) {\n    height = input_height;\n  } else {\n    height = 100;\n  }\n  sketcher_viewer.resize(width, height);\n};\n\nexport const changeLangString = async(iframeContent) => {\n  const button = iframeContent.querySelector(Selectors.elements.canvas.resizeButton);\n  button.firstChild.data =await getString('resize', component);\n\n  var height_input = iframeContent.querySelector(Selectors.elements.canvas.heightInputLabel);\n  height_input.firstChild.data = await getString('height', component);\n\n  var width_input = iframeContent.querySelector(Selectors.elements.canvas.widthInputLabel);\n  width_input.firstChild.data = await getString('width', component);\n};"],"names":["async","editor","iframeBody","sketcherWidth","sketcherHeight","sketcherViewerWidth","sketcherViewerHeight","iframeContent","contentDocument","ChemDoodle","contentWindow","ChemDoodleVar","ELEMENT","jmolColor","sketcher","SketcherCanvas","useServices","requireStartingAtom","readJSON","styles","atoms_displayTerminalCarbonLabels_2D","atoms_useJMOLColors","bonds_clearOverlaps_2D","repaint","sketcher_viewer","ViewerCanvas","emptyMessage","oldFunc","checksOnAction","force","mols","molecules","forms","shapes","loadContent","center","i","ii","this","length","check","sketcherViewerVar","querySelector","Selectors","elements","canvas","resizeButton","addEventListener","function_resize","window","document","setAttribute","changeLangString","e","target","ownerDocument","width","height","input_width","widthInput","valueAsNumber","input_height","heightInput","selector2D","resize","firstChild","data","component","heightInputLabel","widthInputLabel"],"mappings":";;;;;;;;;iOA6B4BA,eAAMC,OACAC,gBACAC,qEAAc,IACdC,sEAAe,IACfC,2EAAoB,IACpBC,4EAAqB,UAC/CC,cAAgBL,WAAWM,oBAC7BC,WAAaP,WAAWQ,cAAcC,cAC1CF,WAAWG,QAAX,EAAwBC,UAAY,QACpCJ,WAAWG,QAAX,EAAwBC,UAAY,gBAE9BC,SAAW,IAAIL,WAAWM,eAAe,WAAYZ,cAAeC,eACxE,CAACY,aAAY,EAAOC,qBAAqB,IAE3CR,WAAWS,SAAS,oBACpBJ,SAASK,OAAOC,sCAAuC,EACvDN,SAASK,OAAOE,qBAAsB,EACtCP,SAASK,OAAOG,wBAAyB,EACzCR,SAASS,gBAGHC,gBAAkB,IAAIf,WAAWgB,aAAa,uBAAwBpB,oBAAqBC,sBACjGkB,gBAAgBL,OAAOC,sCAAuC,EAC9DI,gBAAgBL,OAAOE,qBAAsB,EAC7CG,gBAAgBL,OAAOG,wBAAyB,EAEhDE,gBAAgBE,aAAe,iBAC/BZ,SAASa,QAAUb,SAASc,eAI5Bd,SAASc,eAAiB,SAASC,YAC5BF,QAAQE,WAETC,KAAOhB,SAASiB,UAChBC,MAAQlB,SAASmB,OACrBT,gBAAgBU,YAAYJ,KAAME,OAClClB,SAASqB,aACH,IAAIC,EAAI,EAAGC,GAAKC,KAAKP,UAAUQ,OAAQH,EAAIC,GAAID,SAC9CL,UAAUK,GAAGI,SAGtBtC,WAAWQ,cAAc+B,kBAAoBjB,gBAC7CjB,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOC,cAAcC,iBAAiB,QAASC,gBAAiB9C,YAE/G+C,OAAOC,SAASR,cAAc,kBAAkBS,aAAa,QAAS,wBAChEC,iBAAiB7C,sBAKZyC,gBAAkBK,UACvB9C,cAAgB8C,EAAEC,OAAOC,kBAI3BC,MACAC,OAJAC,YAAcnD,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOc,YAAYC,cAChFC,aAAetD,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOiB,aAAaF,cAMpFJ,MADCE,YAAc,EACPA,YAEA,IAIRD,OADCI,aAAe,EACPA,aAEA,IAbWZ,OAAOC,SAASR,cAAcC,mBAAUC,SAASC,OAAOkB,YAAYrD,cAAc+B,kBAexFuB,OAAOR,MAAOC,wDAGnBL,iBAAmBpD,MAAAA,gBACfO,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOC,cAC9DmB,WAAWC,WAAY,mBAAU,SAAUC,mBAE/B5D,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOuB,kBAC5DH,WAAWC,WAAa,mBAAU,SAAUC,mBAEvC5D,cAAcmC,cAAcC,mBAAUC,SAASC,OAAOwB,iBAC5DJ,WAAWC,WAAa,mBAAU,QAASC"}